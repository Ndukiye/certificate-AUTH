<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Certificate Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Certificate Admin Panel</h1>
            <form action="/logout" method="POST">
                <button type="submit" class="btn btn-danger">Logout</button>
            </form>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                Add New Certificate
            </div>
            <div class="card-body">
                <form id="addCertificateForm">
                    <div class="mb-3">
                        <label for="recipientName" class="form-label">Recipient Name</label>
                        <input type="text" class="form-control" id="recipientName" required>
                    </div>
                    <div class="mb-3">
                        <label for="courseTitle" class="form-label">Course Title</label>
                        <input type="text" class="form-control" id="courseTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="dateIssued" class="form-label">Date Issued</label>
                        <input type="date" class="form-control" id="dateIssued" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Certificate</button>
                </form>
                <div id="addCertMessage" class="mt-3"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                Manage Certificates
            </div>
            <div class="card-body">
                <p>Here you can manage the certificate data and trigger the generation of PDFs.</p>
                <button id="regenerateDataBtn" class="btn btn-primary me-2">
                    <i class="fas fa-sync-alt me-2"></i>Regenerate Certificate Data & QRs
                </button>
                <button id="regeneratePdfBtn" class="btn btn-success me-2">
                    <i class="fas fa-file-pdf me-2"></i>Regenerate All Certificate PDFs
                </button>
                <button id="regenerateMailMergeBtn" class="btn btn-warning me-2">
                    <i class="fas fa-file-word me-2"></i>Regenerate Mail Merge DOCX
                </button>
                <button id="downloadMailMergeBtn" class="btn btn-info">
                    <i class="fas fa-download me-2"></i>Download Mail Merge DOCX
                </button>
                <div id="adminMessage" class="mt-3"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                Current Certificates
            </div>
            <div class="card-body">
                <div id="certificateList" class="list-group"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Redirect to login if not authenticated
        fetch('/api/status')
            .then(response => {
                if (response.status === 401) {
                    window.location.href = '/login';
                }
            })
            .catch(error => console.error('Error checking login status:', error));

        document.addEventListener('DOMContentLoaded', () => {
            const regenerateDataBtn = document.getElementById('regenerateDataBtn');
            const regeneratePdfBtn = document.getElementById('regeneratePdfBtn');
            const regenerateMailMergeBtn = document.getElementById('regenerateMailMergeBtn');
            const downloadMailMergeBtn = document.getElementById('downloadMailMergeBtn');
            const adminMessage = document.getElementById('adminMessage');
            const certificateList = document.getElementById('certificateList');

            async function showMessage(message, type = 'info') {
                adminMessage.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            }

            async function loadCertificates() {
                try {
                    const response = await fetch('/data/certs.json');
                    if (!response.ok) throw new Error('Failed to load certificates');
                    const certs = await response.json();
                    certificateList.innerHTML = '';
                    certs.forEach(cert => {
                        const item = document.createElement('a');
                        item.href = `/?hash=${cert.CurrentHash}`;
                        item.target = "_blank";
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${cert.RecipientName}</h5>
                                <small>${cert.DateIssued}</small>
                            </div>
                            <p class="mb-1">Course: ${cert.CourseTitle}</p>
                            <small>CertID: ${cert.CertID}</small>
                        `;
                        certificateList.appendChild(item);
                    });
                } catch (error) {
                    showMessage(`Error loading certificates: ${error.message}`, 'danger');
                }
            }

            regenerateDataBtn.addEventListener('click', async () => {
                showMessage('Regenerating certificate data and QR codes...', 'info');
                try {
                    const response = await fetch('/api/regenerate-data', { method: 'POST' });
                    const result = await response.json();
                    if (response.ok) {
                        showMessage(result.message, 'success');
                        loadCertificates();
                    } else {
                        showMessage(result.message, 'danger');
                    }
                } catch (error) {
                    showMessage(`Error: ${error.message}`, 'danger');
                }
            });

            regeneratePdfBtn.addEventListener('click', async () => {
                showMessage('Regenerating all certificate PDFs...', 'info');
                try {
                    const response = await fetch('/api/regenerate-pdfs', { method: 'POST' });
                    const result = await response.json();
                    if (response.ok) {
                        showMessage(result.message, 'success');
                    } else {
                        showMessage(result.message, 'danger');
                    }
                } catch (error) {
                    showMessage(`Error: ${error.message}`, 'danger');
                }
            });

            regenerateMailMergeBtn.addEventListener('click', async () => {
                showMessage('Regenerating mail merge DOCX...', 'info');
                try {
                    const response = await fetch('/api/regenerate-mail-merge', { method: 'POST' });
                    const result = await response.json();
                    if (response.ok) {
                        showMessage(result.message, 'success');
                    } else {
                        showMessage(result.message, 'danger');
                    }
                } catch (error) {
                    showMessage(`Error: ${error.message}`, 'danger');
                }
            });

            downloadMailMergeBtn.addEventListener('click', () => {
                window.location.href = '/api/download-mail-merge';
            });

            // Handle Add Certificate Form Submission
            document.getElementById('addCertificateForm').addEventListener('submit', async function(event) {
                event.preventDefault();

                const recipientName = document.getElementById('recipientName').value;
            const courseTitle = document.getElementById('courseTitle').value;
            const dateIssued = document.getElementById('dateIssued').value;

            try {
                const response = await fetch('/api/add-certificate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ recipientName, courseTitle, dateIssued }),
                });

                    const result = await response.json();
                    if (response.ok) {
                        addCertMessage.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                        // Clear form fields
                        document.getElementById('recipientName').value = '';
                        document.getElementById('courseTitle').value = '';
                        document.getElementById('dateIssued').value = '';
                        loadCertificates(); // Refresh the certificate list
                    } else {
                        addCertMessage.innerHTML = `<div class="alert alert-danger">Error: ${result.message}</div>`;
                    }
                } catch (error) {
                    console.error('Error adding certificate:', error);
                    addCertMessage.innerHTML = `<div class="alert alert-danger">An error occurred while adding the certificate.</div>`;
                }
            });

            // Initial load of certificates
            loadCertificates();
        });
    </script>
</body>
</html>